services:
  clewdr-kill:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
    image: clewdr-kill:latest
    container_name: clewdr-kill
    restart: unless-stopped

    # 网络配置
    ports:
      - "8484:8484"
    networks:
      - clewdr-network

    # 卷挂载 - 优化权限和性能
    volumes:
      - ./ban_prompts:/app/ban_prompts:ro # 只读挂载提示词
      - clewdr_data:/app/data # 数据持久化
      - type: tmpfs # 临时文件使用内存
        target: /tmp
        tmpfs:
          size: 100M

    # 环境变量 - 保持高效封号配置
    environment:
      # 日志配置
      - RUST_LOG=info
      - RUST_BACKTRACE=1
      - CLEWDR_LOG_FORMAT=json

      # 高效封号配置 - 针对5000个Cookie优化
      - CLEWDR_BAN_CONCURRENCY=10 # 从20降到10(5000个Cookie更稳定)
      - CLEWDR_BAN_PAUSE_SECONDS=30 # 保持30秒间隔
      - CLEWDR_BAN_MAX_TOKENS=1024 # 从2048降到1024(节省tokens成本)
      - CLEWDR_BAN_REQUEST_TIMEOUT=30000 # 30秒超时

      # 数据清理配置(新增)
      - CLEWDR_CLEANUP_ENABLED=true # 启用自动清理
      - CLEWDR_CLEANUP_INTERVAL_HOURS=1 # 每小时清理一次

      # 性能优化
      - DATABASE_PATH=/app/data/clewdr.db
      - CARGO_TERM_COLOR=always

      # 可选：如果需要代理
      # - CLEWDR_PROXY=http://proxy:8080

    # 资源限制 - 针对10并发+5000个Cookie优化
    deploy:
      resources:
        limits:
          cpus: "1.5" # 从2降到1.5(10并发足够)
          memory: 768M # 从1G降到768M(优化内存占用)
        reservations:
          cpus: "0.5" # 保证0.5个CPU核心
          memory: 384M # 保证384MB内存

    # 健康检查配置
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8484/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s

    # 安全配置
    security_opt:
      - no-new-privileges:true
    read_only: false # 需要写入数据库

    # 依赖关系（如果有其他服务）
    # depends_on:
    #   - proxy

# 网络配置
networks:
  clewdr-network:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 1500

# 卷配置
volumes:
  clewdr_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data
